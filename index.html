<!DOCTYPE html>
<html lang="it">
  <head>
    <meta charset="UTF-8" />
    <meta
      name="viewport"
      content="width=device-width, initial-scale=1.0, user-scalable=no"
    />
    <title>Fantacalcio Budget Tool</title>
    <link
      rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css"
    />
    <style>
      * {
        box-sizing: border-box;
        -webkit-tap-highlight-color: transparent;
      }
      body {
        font-family: "Poppins", sans-serif;
        background: linear-gradient(
          135deg,
          #0b3d0b,
          #136a13,
          #1f8a1f,
          #38c138,
          #a3f7a3
        );

        color: #333;
        margin: 0;
        padding: 15px;
        min-height: 100vh;
        font-size: 16px;
        line-height: 1.4;
      }
      .title-div {
        display: flex;
        justify-content: center;
        margin-bottom: 20px;
        background-color: white;
        border-radius: 12px;
      }

      h1.title {
        text-align: center;
        font-size: 28px;
        font-weight: 700;
        color: #2e8b57;
        margin-bottom: 20px;
        padding: 10px 20px;
        border-radius: 12px;
      }

      .header {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 15px;
        background: white;
        padding: 20px;
        border-radius: 16px;
        box-shadow: 0 4px 20px rgba(0, 0, 0, 0.1);
        margin-bottom: 15px;
        position: relative;
      }
      .stat-box {
        text-align: center;
        position: relative;
      }
      .stat-box i {
        font-size: 28px;
        color: #2e8b57;
        margin-bottom: 8px;
        display: block;
      }
      .stat-box div:not(.stat-value) {
        font-size: 14px;
        margin-bottom: 5px;
        color: #666;
      }
      .stat-value {
        font-weight: bold;
        font-size: 22px;
        color: #2e8b57;
      }
      .budget-counter {
        text-align: center;
        font-weight: bold;
        margin-bottom: 15px;
        font-size: 16px;
        padding: 12px;
        border: 1px solid #e9ecef;
        box-shadow: 1px 1px 6px rgba(0, 0, 0, 0.1);
        background: rgba(255, 255, 255, 0.444);
        border-radius: 12px;
      }
      .budget-panel {
        display: grid;
        grid-template-columns: repeat(2, 1fr);
        gap: 15px;
        background: white;
        padding: 20px;
        border-radius: 16px;
        box-shadow: 0 4px 20px rgba(0, 0, 0, 0.1);
        margin-bottom: 20px;
        position: relative;
      }
      .budget-input {
        display: flex;
        flex-direction: column;
        align-items: center;
        gap: 5px;
        padding: 10px;
        margin: 5px;
        border-radius: 12px;
        background: #f8f9fa;
        position: relative;
      }
      .budget-input i {
        font-size: 24px;
        color: #2e8b57;
      }
      .budget-input input {
        width: 80px;
        padding: 10px 5px;
        text-align: center;
        border: 2px solid #e9ecef;
        border-radius: 10px;
        font-size: 16px;
        font-weight: bold;
        background: white;
      }
      .budget-input input:focus {
        border-color: #2e8b57;
        outline: none;
        box-shadow: 0 0 0 3px rgba(46, 139, 87, 0.1);
      }
      .category {
        background: white;
        border-radius: 16px;
        margin-bottom: 20px;
        box-shadow: 0 4px 20px rgba(0, 0, 0, 0.1);
        overflow: hidden;
        padding: 0px;
      }

      .category-title {
        padding: 12px 15px;
        font-size: 18px;
        font-weight: bold;
        display: flex;
        justify-content: center;
        align-items: center;
        text-align: center;
        gap: 10px;
        color: white;
        margin: 0;
      }

      /* Colori diversi per ogni categoria */
      .title-portieri {
        background: orange;
      }
      .title-difensori {
        background: rgb(13, 255, 0);
      }
      .title-centrocampisti {
        background: blue;
      }
      .title-attaccanti {
        background: red;
      }

      .table-container {
        overflow-x: auto;
        margin-bottom: 15px;
      }
      table {
        width: 100%;
        border-collapse: collapse;
        min-width: 100%;
      }
      th,
      td {
        padding: 12px 8px;
        border-bottom: 1px solid #e9ecef;
        text-align: left;
      }
      th {
        background: #f8f9fa;
        font-weight: 600;
        color: #495057;
        font-size: 14px;
      }
      td:first-child {
        width: 40px;
        text-align: center;
        font-weight: bold;
        color: #6c757d;
      }
      .player-input {
        width: 100%;
        padding: 10px 12px;
        border-radius: 8px;
        border: 1px solid #dee2e6;
        font-size: 16px;
        background: white;
      }
      .player-input:focus {
        border-color: #2e8b57;
        outline: none;
        box-shadow: 0 0 0 2px rgba(46, 139, 87, 0.1);
      }
      .price-input {
        width: 80px;
        padding: 10px 8px;
        text-align: center;
        border: 1px solid #dee2e6;
        border-radius: 8px;
        font-size: 16px;
        font-weight: bold;
        background: white;
      }
      .price-input:focus {
        border-color: #2e8b57;
        outline: none;
        box-shadow: 0 0 0 2px rgba(46, 139, 87, 0.1);
      }
      .remove-player-btn {
        background: transparent;
        border: none;
        color: #dc3545;
        font-size: 20px;
        cursor: pointer;
        padding: 8px;
        border-radius: 6px;
        min-width: 44px;
        min-height: 44px;
        display: flex;
        align-items: center;
        justify-content: center;
      }
      .remove-player-btn:active {
        background: rgba(220, 53, 69, 0.1);
      }
      .tot-reparto {
        font-weight: bold;
        margin-top: 12px;
        padding: 12px 16px;
        display: block;
        text-align: center;
        font-size: 16px;
      }
      .budget-info {
        font-size: 14px;
        justify-content: center;
        display: flex;
        align-items: center;
        padding: 10px 12px;
        font-weight: bold;
        background: #f8f9fa;
        text-align: center;
      }
      .verde {
        background: #d4edda;
        color: #155724;
      }
      .giallo {
        background: #fff3cd;
        color: #856404;
      }
      .rosso {
        background: #f8d7da;
        color: #721c24;
      }
      .blu {
        background: #d1ecf1;
        color: #0c5460;
      }
      /* discreti edit buttons */
      .edit-btn {
        border: none;
        background: none;
        color: #09bd57;
        font-size: 16px;
        cursor: pointer;
        display: flex;
        align-items: center;
        justify-content: center;
        padding: 2px;
      }
      .edit-btn:active {
        opacity: 0.6;
      }
      #budgetTotaleSelect {
        width: 100px;
        padding: 8px 10px;
        border-radius: 12px;
        border: 2px solid #2e8b57;
        background: linear-gradient(135deg, #38c138, #1f8a1f);
        font-weight: bold;
        font-size: 15px;
        text-align: center;
        appearance: none;
        -webkit-appearance: none;
        -moz-appearance: none;
        cursor: pointer;
        box-shadow: 0 2px 6px rgba(0, 0, 0, 0.2);
        transition: all 0.2s ease-in-out;
        background-image: url("data:image/svg+xml,%3Csvg width='12' height='12' viewBox='0 0 24 24' fill='white' xmlns='http://www.w3.org/2000/svg'%3E%3Cpath d='M7 10l5 5 5-5H7z'/%3E%3C/svg%3E");
        background-repeat: no-repeat;
        background-position: right 10px center;
        background-size: 12px;
      }

      #budgetTotaleSelect:focus {
        border-color: #38c138;
        box-shadow: 0 0 0 3px rgba(46, 139, 87, 0.3);
        outline: none;
      }

      #budgetTotaleSelect option {
        background: white;
        color: #333;
        padding: 8px 12px;
      }

      /* NUOVI STILI PER LISTA DESIDERI */
      .tabs-container {
        background: white;
        border-radius: 16px;
        margin-bottom: 20px;
        overflow: hidden;
        box-shadow: 0 4px 20px rgba(0, 0, 0, 0.1);
      }

      .tabs {
        display: flex;
        background: #f8f9fa;
      }

      .tab-btn {
        flex: 1;
        padding: 15px 10px;
        border: none;
        background: transparent;
        font-weight: bold;
        cursor: pointer;
        font-size: 14px;
        transition: all 0.3s ease;
        border-bottom: 3px solid transparent;
      }

      .tab-btn.active {
        background: white;
        color: #2e8b57;
        border-bottom-color: #2e8b57;
      }

      .tab-content {
        display: none;
        padding: 20px;
      }

      .tab-content.active {
        display: block;
      }

      .wishlist-section {
        margin-bottom: 25px;
      }

      .wishlist-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 15px;
        padding: 10px 15px;
        background: #f8f9fa;
        border-radius: 10px;
      }

      .wishlist-title {
        font-weight: bold;
        width: 200px;
        font-size: 16px;
        padding: 8px 12px;
        border-radius: 10px;
        color: white;
        display: inline-block;
        text-align: center;
      }

      .add-wishlist-btn {
        background: #2e8b57;
        color: white;
        border: none;
        width: 30px;
        height: 30px;
        border-radius: 8px;
        cursor: pointer;
        font-size: 14px;
        font-weight: bold;
        transition: all 0.2s ease;
      }

      .add-wishlist-btn:hover {
        background: #1f5d3f;
        transform: translateY(-1px);
      }

      .wishlist-item {
        display: flex;
        align-items: center;
        gap: 10px;
        padding: 12px;
        background: #f8f9fa;
        border-radius: 10px;
        margin-bottom: 10px;
        border: 1px solid #e9ecef;
        transition: all 0.2s ease;
      }

      .wishlist-item:hover {
        border-color: #2e8b57;
        transform: translateY(-1px);
        box-shadow: 0 2px 8px rgba(46, 139, 87, 0.1);
      }

      .wishlist-player-name {
        flex: 1;
        width: 100px;
        padding: 8px 10px;
        border: 1px solid #dee2e6;
        border-radius: 6px;
        font-size: 14px;
      }

      .wishlist-max-price {
        width: 80px;
        padding: 8px;
        border: 1px solid #dee2e6;
        border-radius: 6px;
        text-align: center;
        font-weight: bold;
        font-size: 14px;
      }

      .wishlist-actions {
        display: flex;
        gap: 5px;
      }
      .wishlist-item.priority-low {
        background-color: #05fd0d8d; /* verde */
        color: white;
      }

      .wishlist-item.priority-medium {
        background-color: rgba(255, 217, 0, 0.623); /* oro */
        color: black;
      }

      .wishlist-item.priority-high {
        background-color: #fc13038f; /* rosso */
        color: white;
      }

      .wishlist-item {
        padding: 8px;
        border-radius: 8px;
        margin-bottom: 6px;
        cursor: pointer;
        display: flex;
        align-items: center;
        gap: 8px;
      }

      .acquire-btn {
        background: #28a745;
        color: white;
        border: none;
        padding: 8px 10px;
        border-radius: 6px;
        cursor: pointer;
        font-size: 12px;
        transition: all 0.2s ease;
      }

      .acquire-btn:hover {
        background: #218838;
        transform: scale(1.05);
      }

      .remove-wishlist-btn {
        background: #dc3545;
        color: white;
        border: none;
        padding: 8px 10px;
        border-radius: 6px;
        cursor: pointer;
        font-size: 12px;
        transition: all 0.2s ease;
      }

      .remove-wishlist-btn:hover {
        background: #c82333;
        transform: scale(1.05);
      }

      .wishlist-stats {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 10px 15px;
        background: #e9f7ef;
        border-radius: 8px;
        margin-top: 10px;
        font-size: 14px;
      }

      .wishlist-budget-total {
        font-weight: bold;
        color: #2e8b57;
      }

      .empty-wishlist {
        text-align: center;
        padding: 30px;
        color: #666;
        font-style: italic;
      }

      /* Style per il modal di acquisizione */
      .modal {
        display: none;
        position: fixed;
        z-index: 1000;
        left: 0;
        top: 0;
        width: 100%;
        height: 100%;
        background-color: rgba(0, 0, 0, 0.5);
      }

      .modal-content {
        background-color: white;
        margin: 15% auto;
        padding: 20px;
        border-radius: 12px;
        width: 90%;
        max-width: 400px;
        text-align: center;
      }

      .modal h3 {
        margin-top: 0;
        color: #2e8b57;
      }

      .modal-buttons {
        display: flex;
        gap: 10px;
        justify-content: center;
        margin-top: 20px;
      }

      .modal-btn {
        padding: 10px 20px;
        border: none;
        border-radius: 8px;
        cursor: pointer;
        font-weight: bold;
        transition: all 0.2s ease;
      }

      .modal-btn.confirm {
        background: #28a745;
        color: white;
      }

      .modal-btn.cancel {
        background: #6c757d;
        color: white;
      }

      .modal-btn:hover {
        transform: translateY(-1px);
        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.2);
      }

      .price-suggestion {
        font-size: 12px;
        color: #666;
        margin-top: 5px;
      }

      .over-budget {
        background-color: #fff3cd !important;
        border-color: #ffeaa7 !important;
      }

      .over-budget .wishlist-max-price {
        background-color: #f8d7da;
        border-color: #f5c6cb;
        color: #721c24;
      }

      .wishlist-legend {
        display: flex;
        gap: 15px;
        padding: 10px 15px;
        margin-bottom: 15px;
        border-radius: 8px;
        background-color: #f5f5f5;
        font-weight: bold;
        font-size: 14px;
        flex-wrap: wrap;
      }

      .wishlist-legend .legend-item {
        padding: 5px 10px;
        border-radius: 5px;
        color: #fff;
        cursor: default;
      }

      .wishlist-legend .legend-item.high {
        background-color: #e74c3c;
      } /* rossa */
      .wishlist-legend .legend-item.medium {
        background-color: #f1c40f;
      } /* oro */
      .wishlist-legend .legend-item.low {
        background-color: #2ecc71;
      } /* verde */
      .wishlist-legend .legend-item.none {
        background-color: #95a5a6;
      } /* grigio */

      .priority-btn{
        background: #ffc107;
        border: none;
        border-radius: 6px;
        padding: 6px 8px;
        cursor: pointer;
        font-size: 12px;
        transition: all 0.2s ease;
      }
    </style>
  </head>
  <body>
    <div class="title-div">
      <h1 class="title">Fantacalcio Budget Tool</h1>
    </div>

    <!-- Tabs -->
    <div class="tabs-container">
      <div class="tabs">
        <button class="tab-btn active" onclick="switchTab('budget')">
          <i class="fas fa-calculator"></i> Budget & Rosa
        </button>
        <button class="tab-btn" onclick="switchTab('wishlist')">
          <i class="fas fa-star"></i> Lista Desideri
        </button>
      </div>

      <!-- Budget Tab Content -->
      <div id="budget-tab" class="tab-content active">
        <div class="header">
          <div class="stat-box">
            <i class="fa-solid fa-wallet" style="color: black"></i>
            <div>Totale Budget</div>
            <select id="budgetTotaleSelect">
              <option value="500">500</option>
              <option value="750">750</option>
              <option value="1000" selected>1000</option>
            </select>
          </div>
          <div class="stat-box">
            <i class="fa-solid fa-coins" style="color: goldenrod"></i>
            <div>Rimanente</div>
            <div id="budgetRimanente" class="stat-value">1000</div>
          </div>
        </div>

        <div class="budget-counter" id="budgetRipartito">
          Ripartizione: 1000 / 1000
        </div>

        <div class="budget-panel">
          <button
            id="editRepartiBtn"
            class="edit-btn"
            style="
              position: absolute;
              top: 6px;
              right: 6px;
              font-size: 18px;
              z-index: 1000;
            "
          >
            <i class="fas fa-pencil-alt"></i>
          </button>

          <div class="budget-input">
            <i class="fas fa-hand-paper" style="color: orange"></i>
            <div style="font-size: 12px; color: #666; margin-top: 3px">
              Portieri
            </div>
            <input
              type="number"
              id="budget-portieri"
              value="100"
              min="0"
              disabled
            />
          </div>
          <div class="budget-input">
            <i class="fas fa-shield-alt" style="color: rgb(13, 255, 0)"></i>
            <div style="font-size: 12px; color: #666; margin-top: 4px">
              Difensori
            </div>
            <input
              type="number"
              id="budget-difensori"
              value="300"
              min="0"
              disabled
            />
          </div>
          <div class="budget-input">
            <i class="fas fa-futbol" style="color: #007bff"></i>
            <div style="font-size: 12px; color: #666; margin-top: 4px">
              Centrocampisti
            </div>
            <input
              type="number"
              id="budget-centrocampisti"
              value="400"
              min="0"
              disabled
            />
          </div>
          <div class="budget-input">
            <i class="fas fa-bolt" style="color: red"></i>
            <div style="font-size: 12px; color: #666; margin-top: 4px">
              Attaccanti
            </div>
            <input
              type="number"
              id="budget-attaccanti"
              value="200"
              min="0"
              disabled
            />
          </div>
        </div>

        <div style="text-align: center; margin-bottom: 20px">
          <button
            id="saveCsvBtn"
            style="
              padding: 10px 16px;
              background: #2e8b57;
              color: white;
              font-weight: bold;
              border: none;
              border-radius: 12px;
              cursor: pointer;
              box-shadow: 0 4px 12px rgba(0, 0, 0, 0.2);
              transition: 0.2s;
            "
          >
            Salva Lista
          </button>
        </div>

        <!-- Rosa Giocatori -->
        <div id="rosa-container"></div>
      </div>

      <!-- Wishlist Tab Content -->
      <div id="wishlist-tab" class="tab-content">
        <div id="wishlist-container"></div>
      </div>
    </div>

    <!-- Modal per acquisizione giocatore -->
    <div id="acquireModal" class="modal">
      <div class="modal-content">
        <h3>Acquisisci Giocatore</h3>
        <p id="modalPlayerName"></p>
        <div style="margin: 15px 0">
          <label>Prezzo reale pagato:</label>
          <input
            type="number"
            id="modalRealPrice"
            min="0"
            style="
              width: 100px;
              padding: 8px;
              margin-left: 10px;
              border: 1px solid #dee2e6;
              border-radius: 6px;
              text-align: center;
            "
          />
          <div class="price-suggestion" id="priceSuggestion"></div>
        </div>
        <div class="modal-buttons">
          <button class="modal-btn confirm" onclick="confirmAcquisition()">
            Conferma
          </button>
          <button class="modal-btn cancel" onclick="closeModal()">
            Annulla
          </button>
        </div>
      </div>
    </div>

    <script>
      let budgetIniziale = 1000;
      let currentAcquireData = null;

      const reparti = [
        {
          nome: "PORTIERI",
          id: "portieri",
          n: 3,
          icona: "fas fa-hand-paper",
          budget: 100,
        },
        {
          nome: "DIFENSORI",
          id: "difensori",
          n: 8,
          icona: "fas fa-shield-alt",
          budget: 300,
        },
        {
          nome: "CENTROCAMPISTI",
          id: "centrocampisti",
          n: 8,
          icona: "fas fa-futbol",
          budget: 400,
        },
        {
          nome: "ATTACCANTI",
          id: "attaccanti",
          n: 6,
          icona: "fas fa-bolt",
          budget: 200,
        },
      ];

      // TABS
      function switchTab(tabName) {
        document
          .querySelectorAll(".tab-btn")
          .forEach((btn) => btn.classList.remove("active"));
        document
          .querySelectorAll(".tab-content")
          .forEach((content) => content.classList.remove("active"));
        document
          .querySelector(`[onclick="switchTab('${tabName}')"]`)
          .classList.add("active");
        document.getElementById(`${tabName}-tab`).classList.add("active");
      }

      // WISHLIST
      let wishlist = {
        portieri: [],
        difensori: [],
        centrocampisti: [],
        attaccanti: [],
      };

      function generateWishlist() {
        const container = document.getElementById("wishlist-container");
        container.innerHTML = "";
        reparti.forEach((reparto) => {
          const section = document.createElement("div");
          section.className = "wishlist-section";
          section.innerHTML = `
        <div class="wishlist-header">
          <div class="wishlist-title title-${reparto.id}"><i class="${reparto.icona}"></i> ${reparto.nome}</div>
          <button class="add-wishlist-btn" onclick="addWishlistPlayer('${reparto.id}')">
            <i class="fas fa-plus"></i> 
          </button>
        </div>
        <div id="wishlist-${reparto.id}"></div>
        <div class="wishlist-stats">
          <span>Giocatori desiderati: <span id="count-${reparto.id}">0</span></span>
          <span class="wishlist-budget-total" style="display:none">Budget max: €<span id="budget-wish-${reparto.id}">0</span></span>
        </div>`;
          container.appendChild(section);
          updateWishlistDisplay(reparto.id);
        });
      }

      function addWishlistPlayer(repartoId) {
        wishlist[repartoId].push({ id: Date.now(), nome: "", maxPrice: 0 });
        updateWishlistDisplay(repartoId);
        salvaDati();
      }

      function removeWishlistPlayer(repartoId, playerId) {
        wishlist[repartoId] = wishlist[repartoId].filter(
          (p) => p.id !== playerId
        );
        updateWishlistDisplay(repartoId);
        salvaDati();
      }

      function renderWishlistLegend() {
        const wishlistWrapper = document.getElementById("wishlist-wrapper"); // il contenitore generale della wishlist
        if (!document.querySelector(".wishlist-legend")) {
          // evita duplicati
          const legenda = document.createElement("div");
          legenda.className = "wishlist-legend";
          legenda.innerHTML = `
      <span class="legend-item high">Alta (rossa)</span>
      <span class="legend-item medium">Media (oro)</span>
      <span class="legend-item low">Bassa (verde)</span>
      <span class="legend-item none">Nessuna</span>
    `;
          wishlistWrapper.prepend(legenda); // va in cima al wrapper
        }
      }

      function updateWishlistDisplay(repartoId) {
        const container = document.getElementById(`wishlist-${repartoId}`);
        let players = wishlist[repartoId] || [];

        if (players.length === 0) {
          container.innerHTML =
            '<div class="empty-wishlist">Nessun giocatore nella lista desideri</div>';
        } else {
          container.innerHTML = players
            .map(
              (player) => `
        <div class="wishlist-item priority-${player.priority || 0}">
          <input type="text" class="wishlist-player-name" value="${
            player.nome
          }" placeholder="Nome giocatore"
            onchange="updateWishlistPlayer('${repartoId}', ${
                player.id
              }, 'nome', this.value)">
          <input type="number" class="wishlist-max-price" value="${
            player.maxPrice
          }" min="0" placeholder="Max €"
            onchange="updateWishlistPlayer('${repartoId}', ${
                player.id
              }, 'maxPrice', this.value)">
          <div class="wishlist-actions">
            <button class="priority-btn" onclick="togglePriority('${repartoId}', ${
                player.id
              })" title="Cambia priorità">⚡</button>
            <button class="acquire-btn" onclick="acquirePlayer('${repartoId}', ${
                player.id
              })"><i class="fas fa-plus-circle"></i></button>
            <button class="remove-wishlist-btn" onclick="removeWishlistPlayer('${repartoId}', ${
                player.id
              })"><i class="fas fa-trash"></i></button>
          </div>
        </div>
      `
            )
            .join("");
        }

        // aggiorna sempre il contatore
        const countSpan = document.getElementById(`count-${repartoId}`);
        if (countSpan) countSpan.textContent = players.length;
      }

      // funzione per cambiare priorità al click
      function togglePriority(repartoId, playerId) {
        const player = wishlist[repartoId].find((p) => p.id === playerId);
        if (!player) return;

        switch (player.priority) {
          case "high":
            player.priority = "medium";
            break;
          case "medium":
            player.priority = "low";
            break;
          case "low":
            player.priority = "";
            break;
          default:
            player.priority = "high";
            break;
        }

        updateWishlistDisplay(repartoId);
        salvaDati();
      }

      function updateWishlistPlayer(repartoId, playerId, field, value) {
        const player = wishlist[repartoId].find((p) => p.id === playerId);
        if (player) {
          player[field] = field === "maxPrice" ? parseInt(value) || 0 : value;
          updateWishlistDisplay(repartoId);
          salvaDati();
        }
      }

      // ACQUISTO GIOCATORI
      function acquirePlayer(repartoId, playerId) {
        const player = wishlist[repartoId].find((p) => p.id === playerId);
        if (!player || !player.nome) {
          alert("Inserisci prima il nome del giocatore!");
          return;
        }
        currentAcquireData = { repartoId, playerId, player };
        document.getElementById(
          "modalPlayerName"
        ).textContent = `Vuoi acquistare ${player.nome}?`;
        document.getElementById("modalRealPrice").value = player.maxPrice;
        document.getElementById(
          "priceSuggestion"
        ).textContent = `Prezzo massimo previsto: €${player.maxPrice}`;
        document.getElementById("acquireModal").style.display = "block";
      }

      function closeModal() {
        document.getElementById("acquireModal").style.display = "none";
        currentAcquireData = null;
      }

      function confirmAcquisition() {
        if (!currentAcquireData) return;
        const { repartoId, playerId, player } = currentAcquireData;
        const realPrice =
          parseInt(document.getElementById("modalRealPrice").value) || 0;
        const rows = document.querySelectorAll(`#${repartoId} tr`);
        let slotFound = false;
        for (let row of rows) {
          const nameInput = row.querySelector(".player-input");
          const priceInput = row.querySelector(".price-input");
          if (!nameInput.value) {
            nameInput.value = player.nome;
            priceInput.value = realPrice;
            slotFound = true;
            break;
          }
        }
        if (slotFound) {
          removeWishlistPlayer(repartoId, playerId);
          aggiornaBudget();
          closeModal();
          switchTab("budget");
          alert(`${player.nome} aggiunto alla rosa per €${realPrice}!`);
        } else {
          alert("Non ci sono slot liberi per questo ruolo!");
        }
      }

      // GENERAZIONE TABELLE
      function generaTabelle() {
        const container = document.getElementById("rosa-container");
        container.innerHTML = "";
        reparti.forEach((r) => {
          const categoryDiv = document.createElement("div");
          categoryDiv.className = `category ${r.id}`;
          categoryDiv.style.overflow = "hidden";
          categoryDiv.innerHTML = `
        <h2 class="category-title title-${r.id}"><i class="${r.icona}"></i> ${r.nome}</h2>
        <div class="table-container">
          <table>
            <thead><tr><th>#</th><th>Nome Giocatore</th><th>Prezzo</th><th></th></tr></thead>
            <tbody id="${r.id}"></tbody>
          </table>
        </div>
        <div class="tot-reparto verde" id="tot-${r.id}">Totale ${r.nome}: 0 / ${r.budget}</div>
        <div class="budget-info" id="info-${r.id}">Budget base: ${r.budget}</div>`;
          container.appendChild(categoryDiv);
          const tbody = categoryDiv.querySelector("tbody");
          for (let i = 1; i <= r.n; i++) {
            const tr = document.createElement("tr");
            tr.innerHTML = `
          <td>${i}</td>
          <td><input type="text" class="player-input" placeholder="Nome giocatore"></td>
          <td><input type="number" class="price-input" min="0" value="0" onchange="aggiornaBudget()"></td>
          <td><button class="remove-player-btn" onclick="rimuoviGiocatore(this)"><i class="fas fa-times-circle"></i></button></td>`;
            tbody.appendChild(tr);
          }
        });
      }

      function rimuoviGiocatore(btn) {
        const tr = btn.closest("tr");
        tr.querySelector(".player-input").value = "";
        tr.querySelector(".price-input").value = 0;
        aggiornaBudget();
      }

      function aggiornaBudgetTotale() {
        budgetIniziale =
          parseInt(document.getElementById("budgetTotaleInput").value) || 1000;
        aggiornaBudget();
      }

      // CALCOLO BUDGET
      function aggiornaBudget() {
        let totaleSpeso = 0,
          rollover = 0;
        reparti.forEach((r) => {
          const prezzi = document.querySelectorAll(`#${r.id} .price-input`);
          let speso = 0;
          prezzi.forEach((i) => (speso += parseInt(i.value) || 0));
          const inputBudget = document.getElementById(`budget-${r.id}`);
          let budgetEffettivo = parseInt(inputBudget.value) || 0;
          const infoBox = document.getElementById(`info-${r.id}`);
          if (infoBox) infoBox.textContent = `Budget base: ${budgetEffettivo}`;
          let colore = "verde",
            mess = "";
          if (speso > budgetEffettivo) {
            colore = "rosso";
            mess = ` (Sforato di ${speso - budgetEffettivo})`;
          } else if (speso >= budgetEffettivo * 0.9) colore = "giallo";
          else if (speso < budgetEffettivo) {
            colore = "blu";
            mess = ` (Residuo: ${r.budget + rollover})`;
          }
          const box = document.getElementById(`tot-${r.id}`);
          if (box) {
            box.className = `tot-reparto ${colore}`;
            box.innerHTML = `Totale ${
              r.nome
            }: ${speso} / ${budgetEffettivo}${mess}
          <div style="font-size: 12px; color: #666; margin-top:4px;">
            ${
              rollover > 0
                ? `(da reparto precedente: ${rollover} → totale effettivo: ${
                    r.budget + rollover
                  })`
                : `(Residuo budget: ${budgetEffettivo - speso})`
            }
          </div>`;
          }
          rollover = budgetEffettivo - speso;
          totaleSpeso += speso;
        });
        const rim = document.getElementById("budgetRimanente");
        rim.textContent = budgetIniziale - totaleSpeso;
        rim.style.color =
          budgetIniziale - totaleSpeso < 0 ? "#dc3545" : "#2e8b57";
        const totRipartito = reparti.reduce(
          (a, r) =>
            a +
            (parseInt(document.getElementById(`budget-${r.id}`).value) || 0),
          0
        );
        const ripBox = document.getElementById("budgetRipartito");
        ripBox.textContent = `Ripartizione: ${totRipartito} / ${budgetIniziale}`;
        if (totRipartito > budgetIniziale) {
          ripBox.style.color = "#dc3545"; // rosso
        } else {
          ripBox.style.color = "#2e8b57"; // verde
        }
      }

      function aggiornaBudgetReparto(id) {
        const val =
          parseInt(document.getElementById(`budget-${id}`).value) || 0;
        const r = reparti.find((x) => x.id === id);
        r.budget = val;
        aggiornaBudget();
      }

      // SALVATAGGIO
      function salvaDati() {
        const data = {
          budgetTotale: document.getElementById("budgetTotaleSelect").value,
          reparti: reparti.map((r) => {
            const rows = Array.from(document.querySelectorAll(`#${r.id} tr`));
            return {
              id: r.id,
              budget: document.getElementById(`budget-${r.id}`).value,
              players: rows.map((row) => {
                const nome = row.querySelector(".player-input")?.value || "";
                const prezzo = row.querySelector(".price-input")?.value || "";
                return { nome, prezzo };
              }),
            };
          }),
          wishlist: wishlist,
        };
        localStorage.setItem("fantacalcioData", JSON.stringify(data));
        console.log("Dati salvati:", data);
      }

      function caricaDati() {
        const saved = localStorage.getItem("fantacalcioData");
        if (!saved) return;
        const data = JSON.parse(saved);
        if (data.budgetTotale) {
          document.getElementById("budgetTotaleSelect").value =
            data.budgetTotale;
          budgetIniziale = parseInt(data.budgetTotale);
        }
        if (data.reparti) {
          data.reparti.forEach((rep) => {
            const inputBudget = document.getElementById(`budget-${rep.id}`);
            if (inputBudget) inputBudget.value = rep.budget;
            const rows = document.querySelectorAll(`#${rep.id} tr`);
            rep.players.forEach((p, i) => {
              if (rows[i]) {
                const nomeInput = rows[i].querySelector(".player-input");
                const prezzoInput = rows[i].querySelector(".price-input");
                if (nomeInput) nomeInput.value = p.nome;
                if (prezzoInput) prezzoInput.value = p.prezzo;
              }
            });
          });
        }
        if (data.wishlist) {
          wishlist = data.wishlist;
          reparti.forEach((r) => updateWishlistDisplay(r.id));
        }
        aggiornaBudget();
      }

      // EVENTI
      document.addEventListener("DOMContentLoaded", () => {
        generaTabelle();
        generateWishlist();
        const editRepartiBtn = document.getElementById("editRepartiBtn");
        editRepartiBtn.addEventListener("click", () => {
          const inputs = reparti.map((r) =>
            document.getElementById(`budget-${r.id}`)
          );
          if (inputs[0].disabled) {
            inputs.forEach((i) => (i.disabled = false));
            editRepartiBtn.innerHTML =
              '<i class="fas fa-check" style="color:#2e8b57"></i>';
          } else {
            inputs.forEach((i) => (i.disabled = true));
            editRepartiBtn.innerHTML = '<i class="fas fa-pencil-alt"></i>';
            reparti.forEach((r) => aggiornaBudgetReparto(r.id));
          }
        });
        const budgetSelect = document.getElementById("budgetTotaleSelect");
        budgetSelect.addEventListener("change", () => {
          budgetIniziale = parseInt(budgetSelect.value);
          aggiornaBudget();
          salvaDati();
        });
        document.body.addEventListener("input", salvaDati);
        caricaDati();
        aggiornaBudget();
      });

      // CSV EXPORT
      document.getElementById("saveCsvBtn").addEventListener("click", () => {
        let csvContent =
          "Categoria,Giocatore,Prezzo,Budget Base,Budget Effettivo,Residuo\n";
        reparti.forEach((r) => {
          const budgetBase = parseInt(
            document.getElementById(`budget-${r.id}`).value || 0
          );
          const rows = document.querySelectorAll(`#${r.id} tr`);
          rows.forEach((row) => {
            const nome = row.querySelector(".player-input").value;
            const prezzo = parseInt(
              row.querySelector(".price-input").value || 0
            );
            const residuo = budgetBase - prezzo;
            if (nome || prezzo)
              csvContent += `${r.nome},${nome},${prezzo},${budgetBase},${budgetBase},${residuo}\n`;
          });
        });
        csvContent +=
          "\n--- LISTA DESIDERI ---\nCategoria,Giocatore Desiderato,Budget Massimo\n";
        reparti.forEach((r) => {
          wishlist[r.id].forEach((player) => {
            if (player.nome)
              csvContent += `${r.nome},${player.nome},${player.maxPrice}\n`;
          });
        });
        const blob = new Blob([csvContent], {
          type: "text/csv;charset=utf-8;",
        });
        const link = document.createElement("a");
        link.setAttribute("href", URL.createObjectURL(blob));
        link.setAttribute("download", "fantacalcio_budget_completo.csv");
        document.body.appendChild(link);
        link.click();
        document.body.removeChild(link);
        alert("Export completato! File scaricato con rosa e lista desideri.");
      });

      // Chiudi modal cliccando fuori
      window.onclick = (e) => {
        const modal = document.getElementById("acquireModal");
        if (e.target === modal) closeModal();
      };
    </script>
  </body>
</html>
